!function(e){"use strict";const a={apiEndpoint:"https://api.marketin.now/api/v1/",debug:!0,sessionId:null,affiliateId:null,campaignId:null,brandId:null},t={generateUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const a=16*Math.random()|0;return("x"===e?a:3&a|8).toString(16)}),getQueryParam:a=>new URLSearchParams(e.location.search).get(a),setCookie:(a,t,r=30)=>{try{const i=new Date(Date.now()+864e5*r).toUTCString();let o=`${a}=${encodeURIComponent(t)}; expires=${i}; path=/; SameSite=Lax`;"https:"===e.location.protocol&&(o+="; Secure"),document.cookie=o}catch(e){}},getCookie:e=>{try{const a=document.cookie?document.cookie.split("; "):[];for(const t of a){const[a,r]=t.split("=");if(a===e)return decodeURIComponent(r||"")}}catch(e){}return null},REFERRAL_KEY:"marketin_referral",COOKIE_MAX_AGE:2592e3,saveReferralParams:(e={})=>{const a=JSON.stringify(e);try{const e=t.COOKIE_MAX_AGE;document.cookie=`${t.REFERRAL_KEY}=${encodeURIComponent(a)}; path=/; max-age=${e}; SameSite=Lax`,localStorage.setItem(t.REFERRAL_KEY,a)}catch(e){t.log("Failed to save referral params: "+e.message)}},getReferralParams:()=>{let e=null;try{const a=document.cookie.match(new RegExp("(^| )"+t.REFERRAL_KEY+"=([^;]+)"));a&&(e=JSON.parse(decodeURIComponent(a[2])))}catch(e){}if(!e)try{e=JSON.parse(localStorage.getItem(t.REFERRAL_KEY))}catch(e){}return e||{}},clearReferralParams:()=>{try{document.cookie=`${t.REFERRAL_KEY}=; Max-Age=0; path=/;`,localStorage.removeItem(t.REFERRAL_KEY)}catch(e){t.log("Failed to clear referral params: "+e.message)}},syncReferralStorage:()=>{let a=null,r=null;try{const e=document.cookie.match(new RegExp("(^| )"+t.REFERRAL_KEY+"=([^;]+)"));e&&(a=JSON.parse(decodeURIComponent(e[2])))}catch(e){}try{r=JSON.parse(localStorage.getItem(t.REFERRAL_KEY))}catch(e){}if(a&&!r)localStorage.setItem(t.REFERRAL_KEY,JSON.stringify(a));else if(!a&&r){const a=t.COOKIE_MAX_AGE;document.cookie=`${t.REFERRAL_KEY}=${encodeURIComponent(JSON.stringify(r))}; path=/; max-age=${a}; SameSite=Lax`,"https:"===e.location.protocol&&(document.cookie+="; Secure")}},log:(e="")=>{a.debug&&console.log(`[MarketIn SDK] ${e}`)}},r={init:(i={})=>{Object.assign(a,i),i.campaignId&&!a.campaignId&&(a.campaignId=i.campaignId),i.brandId&&(a.brandId=i.brandId),i.referralParams&&(t.saveReferralParams(i.referralParams),i.referralParams.affiliateId&&(a.affiliateId=i.referralParams.affiliateId),i.referralParams.campaignId&&(a.campaignId=i.referralParams.campaignId),i.referralParams.productId&&(a.productId=i.referralParams.productId),i.referralParams.clickId&&(a.clickId=i.referralParams.clickId)),a.sessionId||(a.sessionId=t.generateUUID()),t.syncReferralStorage();const o=t.getQueryParam("aid")||t.getQueryParam("affiliate_id"),n=t.getQueryParam("cid")||t.getQueryParam("campaign_id"),c=t.getQueryParam("pid")||t.getQueryParam("product_id");if(o&&n){a.affiliateId=o,a.campaignId=n;const i=t.getQueryParam("mi_click");r.trackAffiliateClick({affiliateId:o,campaignId:n,productId:c,clickId:i,referrer:document.referrer,landingUrl:e.location.href})}r.trackPageView(),t.log("SDK initialized")},trackPageView:(i={})=>{const o={url:i.url||e.location.href,referrer:i.referrer||document.referrer,sessionId:i.sessionId||a.sessionId,timestamp:i.timestamp||(new Date).toISOString(),userAgent:i.userAgent||navigator.userAgent,screenResolution:i.screenResolution||`${e.screen.width}x${e.screen.height}`,language:i.language||navigator.language,pageTitle:i.pageTitle||document.title,utmSource:i.utmSource??t.getQueryParam("utm_source"),utmMedium:i.utmMedium??t.getQueryParam("utm_medium"),utmCampaign:i.utmCampaign??t.getQueryParam("utm_campaign"),utmTerm:i.utmTerm??t.getQueryParam("utm_term"),utmContent:i.utmContent??t.getQueryParam("utm_content"),campaignId:i.campaignId??a.campaignId??t.getQueryParam("cid")??t.getQueryParam("campaign_id"),affiliateId:i.affiliateId??a.affiliateId??t.getQueryParam("aid")??t.getQueryParam("affiliate_id"),brandId:i.brandId??a.brandId};console.log("log activity data",o),r.sendToAPI("log-activity",o)},trackAffiliateClick:(i,o)=>{try{const n="object"==typeof i?i:{affiliateId:i,campaignId:o},{affiliateId:c,campaignId:d}=n;if(!c||!d)return void t.log("trackAffiliateClick requires both affiliateId and campaignId");a.affiliateId=a.affiliateId||c,a.campaignId=a.campaignId||d,t.saveReferralParams({affiliateId:a.affiliateId,campaignId:a.campaignId,timestamp:Date.now()});const s=t.getCookie("mi_click"),l=n.clickId||t.getQueryParam("mi_click")||s||t.generateUUID();!s&&l&&t.setCookie("mi_click",l,30);const m={affiliateId:n.affiliateId,campaignId:n.campaignId,productId:n.productId||void 0,clickId:l||void 0,referrer:n.referrer||document.referrer,url:n.landingUrl||e.location.href,sessionId:a.sessionId,timestamp:n.timestamp||(new Date).toISOString(),userAgent:n.userAgent||navigator.userAgent};console.log("affiliate click data from sdk:",m),r.sendToAPI("log-affiliate-click",m),t.log(`Affiliate click tracked: ${c}`)}catch(e){t.log(`Failed to track affiliate click: ${e.message}`)}},sendToAPI:(e,r)=>{try{const i=`${a.apiEndpoint}/${e}/`,o={"Content-Type":"application/javascript","X-Content-Type-Options":"nosniff","X-MarketIn-SDK":"1.0.1"};a.campaignId&&(o["X-CAMPAIGN-ID"]=a.campaignId),a.brandId&&(o["X-BRAND-ID"]=a.brandId),t.log(`Sending request to: ${i}`),fetch(i,{method:"POST",headers:o,body:JSON.stringify(r)}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}).then(e=>{t.log(`API Success: ${JSON.stringify(e)}`)}).catch(e=>{t.log(`API Error: ${e.message}`)}),console.log("Marketin Server SDK API Success:",response)}catch(e){t.log(`Failed to send API request: ${e.message}`)}},crawlPageData:()=>{try{t.log("Starting page data crawl");const a={url:e.location.href,title:document.title,meta:{description:document.querySelector('meta[name="description"]')?.content||"",keywords:document.querySelector('meta[name="keywords"]')?.content||""},products:Array.from(document.querySelectorAll("[data-marketin-product]")).map(e=>({id:e.dataset.marketinProduct,name:e.dataset.marketinProductName||"",price:e.dataset.marketinProductPrice||"0",category:e.dataset.marketinProductCategory||""}))};t.log(`Found ${a.products.length} products to crawl`),a.products.length>0&&t.log(`Product names: ${a.products.map(e=>e.name).join(", ")}`),r.sendToAPI("crawl-data",a)}catch(e){t.log(`Failed to crawl page data: ${e.message}`),console.log(`Failed to crawl page data: ${e.message}`)}},trackConversion:({eventType:i,value:o,currency:n="USD",conversionRef:c,productId:d,cartItems:s,metadata:l={},subscriptionId:m,periodNumber:g,planId:u,interval:f,recurringAmount:I,subscriptionStatus:p}={})=>{try{if(!a.campaignId||!a.affiliateId)return void t.log("Conversion skipped: missing campaignId or affiliateId");const y="string"==typeof i&&i.startsWith("subscription"),P=Array.isArray(s)?s.filter(e=>e&&"object"==typeof e):[];if(!y&&!d&&0===P.length)return void t.log("Conversion aborted: productId is required for non-subscription events");const R=`mi_conv_${a.sessionId}_${i}`,k=e.localStorage.getItem(R);if(k&&k===c)return void t.log(`Duplicate conversion ignored for event: ${i}`);const v=d||(P.length>0?P[0].productId||P[0].product_id:void 0)||t.getQueryParam("pid")||t.getQueryParam("product_id"),S=(e,a=0)=>{if(null==e||""===e)return a;const t="string"==typeof e?parseFloat(e):Number(e);return Number.isFinite(t)?t:a},h=P.length?P.reduce((e,a)=>e+S(a.price)*(S(a.quantity,1)||1),0):null,A=S(o,0),_=null!==h&&h>0?h:A,E=()=>{if(0!==P.length)return P.map(e=>{const a=Object.assign({},e);if(void 0===a.productId&&void 0!==a.product_id&&(a.productId=a.product_id),void 0===a.affiliateId&&void 0!==a.affiliate_id&&(a.affiliateId=a.affiliate_id),void 0===a.campaignId&&void 0!==a.campaign_id&&(a.campaignId=a.campaign_id),void 0===a.quantity&&(a.quantity=1),a.productId=void 0!==a.productId?a.productId:v,delete a.product_id,delete a.affiliate_id,delete a.campaign_id,!a.affiliateId||!a.campaignId){const e=t.getReferralParams();e.affiliateId&&!a.affiliateId&&(a.affiliateId=e.affiliateId),e.campaignId&&!a.campaignId&&(a.campaignId=e.campaignId)}return a})},x={campaignId:parseInt(a.campaignId),affiliateId:parseInt(a.affiliateId),sessionId:a.sessionId,eventType:i,value:Number.isFinite(_)?Number(_.toFixed(2)):0,currency:n,conversionRef:c||t.generateUUID()};v&&(x.productId=v);const $=E();$&&(x.cartItems=$),i&&i.startsWith("subscription")?x.metadata=Object.assign({},l,{subscriptionId:m,periodNumber:g,planId:u,interval:f,recurringAmount:I,subscriptionStatus:p}):Object.keys(l).length&&(x.metadata=l);const b=a.token?"log-conversion":"sdk-log-conversion";r.sendToAPI(b,x),e.localStorage.setItem(R,x.conversionRef),t.log(`Conversion tracked: ${i} ${x.value} ${n}`),console.log(`Conversion tracked: ${i} ${x.value} ${n}`)}catch(e){t.log(`Failed to track conversion: ${e.message}`)}},getStatus:()=>({version:"1.0.1",config:{...a},sessionId:a.sessionId,initialized:!!a.sessionId}),saveReferralParams:t.saveReferralParams,getReferralParams:t.getReferralParams,clearReferralParams:t.clearReferralParams,syncReferralStorage:t.syncReferralStorage};e.MarketIn=r}(window);